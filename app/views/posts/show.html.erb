<div class="main posts-show">
  <div class="container">
  <h1 class="form-heading">投稿詳細</h1>
    <div class="posts-show-item">
      <div class="post-user-name">
        <img src="<%= "/user_images/#{@post.user.image_name}" %>">
        <%= link_to(@post.user.name, "/users/#{@post.user.id}") %>
      </div>
      <br>
      <div class="post-time">
        <%= @post.created_at.strftime('%Y年%m月%d日 %H時%M分') %>
      </div>
      <p>
        <div class="post-index-content pb-2">
          <div class="post-index-content-title">(1) 仕事で感じたこと</div>
          <%= simple_format(@post.work_content, class: 'font-12') %>
        </div>
        <div class="post-index-content pb-2">
          <div class="post-index-content-title">(2) (1)の深掘り（解析・分析）</div>
          <%= simple_format(@post.content, class: 'font-12') %>
        </div>
        <div class="post-index-content pb-2">
          <div class="post-index-content-title">(3) 自己学習について</div>
          <%= simple_format(@post.study_content, class: 'font-12') %>
        </div>
        <div class="post-index-content">
          <div class="post-index-content-title">(4) 特記事項</div>
          <%= simple_format(@post.notices_content, class: 'font-12') %>
        </div>
      </p>
      <% if Like.find_by(user_id: @current_user.id, post_id: @post.id) %>
        <%= link_to("/likes/#{@post.id}/destroy", {method: "post"}) do %>
          <span class="fa fa-heart liked-btn"></span>
        <% end %>
      <% else %>
        <%= link_to("/likes/#{@post.id}/create", {method: "post"}) do %>
          <span class="fa fa-heart unliked-btn"></span>
        <% end %>
      <% end %>

      <%= @likes_count %>
      <% if @post.user_id == @current_user.id %>
        <div class="post-menus">
          <%= link_to("編集", "/posts/#{@post.id}/edit") %>
          <%= link_to("削除", "/posts/#{@post.id}/destroy", {method: "post", data: { confirm: "本当に削除してもよろしいですか？"} }) %>
        </div>
      <% end %>
    </div>
    <div id="word-cloud" class="mt-4" style="display: none;"></div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
    <script>
      fetch("<%= "/posts/#{@post.id}/word_cloud" %>")
        .then(response => response.json())
        .then(data => {
          const layout = d3.layout.cloud()
            .size([600, 400])
            .words(data)
            .padding(5)
            .rotate(() => ~~(Math.random() * 2) * 90)
            .font("Impact")
            .fontSize(d => d.size)
            .on("end", draw);

          layout.start();

          function draw(words) {
            d3.select("#word-cloud").append("svg")
              .attr("width", 600)
              .attr("height", 400)
              .append("g")
              .attr("transform", "translate(300,200)")
              .selectAll("text")
              .data(words)
              .enter().append("text")
              .style("font-size", d => d.size + "px")
              .style("font-family", "Impact")
              .style("fill", () => d3.schemeCategory10[Math.floor(Math.random() * 10)])
              .attr("text-anchor", "middle")
              .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
              .text(d => d.text);
          }
        });
    </script>
  </div>
</div>

